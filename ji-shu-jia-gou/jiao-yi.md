# 交易

### 交易生命周期

现在我们对 sofa 的每个组件有了更好的了解，让我们看看在下订单时它们是如何组合在一起的。在 sofa 上下订单时，它遵循以下流程：

1. **交易请求**：用户在去中心化的前端（例如网站）或通过 API 进行交易。
2. **交易提交**：交易提交后，需要经过一定的`check_tx`流程才能进入内存池。如果交易有效，则进入内存池；如果交易无效，则会发送错误响应。
3. **内存池验证**：交易必须通过`check_tx`流程才能添加到内存池中。创建每个区块后，内存池会对`recheck_tx`剩余交易执行验证，过滤掉由于区块执行期间状态变化而失败的交易。
4. **交易传播至验证者**：一旦交易成功进入内存池，所有节点都会通过点对点 (p2p) 通信共享该交易。这确保了交易能够被传送至生成区块的验证者。该验证者将该交易传播给其他验证者和完整节点，以使用新订单更新他们的订单簿。
5. **区块生成**：共识流程挑选一名验证者作为提议者。选定的验证者匹配订单并将其添加到其下一个提议区块中，必须遵循 cometbft 规则，使用内存池中的交易创建一个区块。
6. **区块执行**：提议的区块将通过共识过程继续执行
   * 如果⅔的验证者节点投票确认该区块，则该区块将被提交并保存到所有验证者和完整节点的链上数据库中。
   * 如果提议的区块未能成功达到 ⅔ 阈值，则该区块被拒绝。
7. **区块提交**：提交区块后，更新后的链上（和链下）数据将从完整节点传输到索引器。然后，索引器通过 API 和 Websockets 将这些数据提供给前端和/或查询这些数据的任何其他外部服务。
